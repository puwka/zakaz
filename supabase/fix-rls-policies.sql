-- ============================================
-- ИСПРАВЛЕНИЕ RLS ПОЛИТИК ДЛЯ ПУБЛИЧНОГО ДОСТУПА
-- ============================================
-- Выполните этот скрипт, если получаете ошибку 401 при загрузке товаров

-- Удаляем существующие политики для товаров (если нужно пересоздать)
DROP POLICY IF EXISTS "Публичное чтение активных товаров" ON products;
DROP POLICY IF EXISTS "Админ может читать все товары" ON products;

-- Создаем политику для публичного чтения активных товаров
-- ВАЖНО: Эта политика должна быть первой и применяться к анонимным пользователям
CREATE POLICY "Публичное чтение активных товаров"
    ON products FOR SELECT
    TO anon, authenticated
    USING (is_active = true);

-- Политика для админов (читают все товары, включая неактивные)
CREATE POLICY "Админ может читать все товары"
    ON products FOR SELECT
    TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.users.id = auth.uid()
        )
    );

-- ============================================
-- ПРОВЕРКА: Убедитесь, что RLS включен
-- ============================================
-- Выполните эти команды для проверки:
-- SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND tablename = 'products';
-- Должно вернуть: rowsecurity = true

-- Если RLS не включен, выполните:
-- ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- ============================================
-- ТЕСТОВЫЙ ЗАПРОС
-- ============================================
-- Выполните этот запрос, чтобы проверить, что политики работают:
-- SELECT COUNT(*) FROM products WHERE is_active = true;






