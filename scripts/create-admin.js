/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 * 
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 * 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env.local –µ—Å—Ç—å SUPABASE_SERVICE_ROLE_KEY
 * 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: node scripts/create-admin.js <email> <password>
 * 
 * –ü—Ä–∏–º–µ—Ä:
 * node scripts/create-admin.js admin@example.com mypassword123
 */

require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

const email = process.argv[2];
const password = process.argv[3];

if (!email || !password) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  console.log('\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:');
  console.log('  node scripts/create-admin.js <email> <password>');
  console.log('\n–ü—Ä–∏–º–µ—Ä:');
  console.log('  node scripts/create-admin.js admin@example.com mypassword123');
  process.exit(1);
}

if (password.length < 6) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
  process.exit(1);
}

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceRoleKey) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  console.log('\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env.local –µ—Å—Ç—å:');
  console.log('  NEXT_PUBLIC_SUPABASE_URL=...');
  console.log('  SUPABASE_SERVICE_ROLE_KEY=...');
  process.exit(1);
}

async function createAdmin() {
  try {
    console.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
    console.log(`   Email: ${email}`);
    
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å Service Role Key
    const supabase = createClient(supabaseUrl, serviceRoleKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true, // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º email
    });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', error.message);
      
      if (error.message.includes('already registered')) {
        console.log('\nüí° –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
        console.log('   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π email –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –≤ Supabase Dashboard.');
      }
      
      process.exit(1);
    }

    console.log('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
    console.log(`\nüìß Email: ${data.user.email}`);
    console.log(`üÜî ID: ${data.user.id}`);
    console.log('\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:');
    console.log('  http://localhost:3000/admin/login');
    console.log(`\n  Email: ${email}`);
    console.log(`  –ü–∞—Ä–æ–ª—å: ${password}`);
    
  } catch (err) {
    console.error('‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', err.message);
    process.exit(1);
  }
}

createAdmin();

